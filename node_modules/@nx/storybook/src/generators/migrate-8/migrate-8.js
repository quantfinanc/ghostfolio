"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.migrate8Generator = migrate8Generator;
const devkit_1 = require("@nx/devkit");
const output_1 = require("nx/src/utils/output");
const calling_storybook_cli_1 = require("./calling-storybook-cli");
const helper_functions_1 = require("./helper-functions");
async function migrate8Generator(tree, schema) {
    const packageJson = (0, devkit_1.readJson)(tree, 'package.json');
    if (!(0, helper_functions_1.checkStorybookInstalled)(packageJson)) {
        output_1.output.error({
            title: 'No Storybook packages installed',
            bodyLines: [
                `ðŸš¨ Nx did not find any Storybook packages installed in your workspace.`,
                `So no migration is necessary.`,
            ],
        });
        return;
    }
    const allStorybookProjects = (0, helper_functions_1.getAllStorybookInfo)(tree);
    if (schema.onlyShowListOfCommands) {
        (0, helper_functions_1.onlyShowGuide)(allStorybookProjects);
        return;
    }
    if (!schema.noUpgrade) {
        (0, calling_storybook_cli_1.callUpgrade)(schema);
    }
    if (Object.entries(allStorybookProjects).length) {
        let migrateResult;
        migrateResult = (0, calling_storybook_cli_1.callAutomigrate)(allStorybookProjects, schema);
        migrateResult = (0, helper_functions_1.handleMigrationResult)(migrateResult, allStorybookProjects);
        (0, helper_functions_1.logResult)(tree, migrateResult);
    }
    await (0, devkit_1.formatFiles)(tree);
}
exports.default = migrate8Generator;
